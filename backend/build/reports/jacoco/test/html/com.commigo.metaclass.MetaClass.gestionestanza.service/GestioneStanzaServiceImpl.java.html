<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="it"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>GestioneStanzaServiceImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">MetaClass</a> &gt; <a href="index.source.html" class="el_package">com.commigo.metaclass.MetaClass.gestionestanza.service</a> &gt; <span class="el_source">GestioneStanzaServiceImpl.java</span></div><h1>GestioneStanzaServiceImpl.java</h1><pre class="source lang-java linenums">package com.commigo.metaclass.MetaClass.gestionestanza.service;

import com.commigo.metaclass.MetaClass.entity.*;
import com.commigo.metaclass.MetaClass.exceptions.RuntimeException401;
import com.commigo.metaclass.MetaClass.exceptions.RuntimeException403;
import com.commigo.metaclass.MetaClass.exceptions.ServerRuntimeException;
import com.commigo.metaclass.MetaClass.gestioneamministrazione.repository.ScenarioRepository;
import com.commigo.metaclass.MetaClass.gestionemeeting.repository.MeetingRepository;
import com.commigo.metaclass.MetaClass.gestionestanza.repository.RuoloRepository;
import com.commigo.metaclass.MetaClass.gestionestanza.repository.StanzaRepository;
import com.commigo.metaclass.MetaClass.gestionestanza.repository.StatoPartecipazioneRepository;
import com.commigo.metaclass.MetaClass.gestioneutenza.repository.UtenteRepository;
import com.commigo.metaclass.MetaClass.utility.response.ResponseUtils;
import com.commigo.metaclass.MetaClass.utility.response.types.AccessResponse;
import com.commigo.metaclass.MetaClass.utility.response.types.Response;
import com.commigo.metaclass.MetaClass.webconfig.JwtTokenUtil;
import com.commigo.metaclass.MetaClass.webconfig.ValidationToken;
import jakarta.transaction.Transactional;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Service;

import java.util.List;
import java.util.Map;

@Service
<span class="nc" id="L30">@RequiredArgsConstructor</span>
<span class="nc" id="L31">@Slf4j</span>
@Transactional    //ogni operazione è una transazione
public class GestioneStanzaServiceImpl implements GestioneStanzaService {

    private final StatoPartecipazioneRepository statoPartecipazioneRepository;
    private final RuoloRepository ruoloRepository;
    private final StanzaRepository stanzaRepository;
    private final UtenteRepository utenteRepository;
    private final ScenarioRepository scenarioRepository;
    private final MeetingRepository meetingRepository;

    @Autowired
    private ValidationToken validationToken;

    @Autowired
    private JwtTokenUtil jwtTokenUtil;

    /**
     * @param codiceStanza
     * @param id_utente
     * @return
     * @throws Exception
     */
    @Override
    public ResponseEntity&lt;AccessResponse&lt;Long&gt;&gt; accessoStanza(String codiceStanza, String id_utente)
            throws ServerRuntimeException, RuntimeException403{

        //controllo stanza se è vuota
<span class="nc" id="L59">        Stanza stanza = stanzaRepository.findStanzaByCodice(codiceStanza);</span>
<span class="nc bnc" id="L60" title="All 2 branches missed.">        if (stanza == null)</span>
<span class="nc" id="L61">            throw new RuntimeException403(&quot;stanza non trovata&quot;);</span>

        //prelevo l'utente
<span class="nc" id="L64">        Utente u = utenteRepository.findFirstByMetaId(id_utente);</span>
<span class="nc bnc" id="L65" title="All 2 branches missed.">        if(u == null) throw new ServerRuntimeException(&quot;utente non trovato&quot;);</span>

<span class="nc" id="L67">        StatoPartecipazione sp = statoPartecipazioneRepository</span>
<span class="nc" id="L68">                .findStatoPartecipazioneByUtenteAndStanza(u, stanza);</span>

<span class="nc bnc" id="L70" title="All 2 branches missed.">        if (sp == null) {</span>
<span class="nc" id="L71">            sp = new StatoPartecipazione(stanza, u, ruoloRepository.findByNome(Ruolo.PARTECIPANTE),</span>
<span class="nc bnc" id="L72" title="All 2 branches missed.">                    !stanza.isTipo_Accesso(), false, u.getNome(), true);</span>
<span class="nc" id="L73">            statoPartecipazioneRepository.save(sp);</span>

            //verifico se la stanza è privata o pubblica
<span class="nc bnc" id="L76" title="All 2 branches missed.">            if(stanza.isTipo_Accesso())</span>
<span class="nc" id="L77">                return ResponseEntity.ok(new AccessResponse&lt;&gt;(stanza.getId(), &quot;Accesso effettuato con successo&quot;, false));</span>
            else
<span class="nc" id="L79">                 return ResponseEntity.ok(new AccessResponse&lt;&gt;(0L, &quot;Richiesta accesso alla stanza effettuata&quot;, true));</span>

<span class="nc bnc" id="L81" title="All 2 branches missed.">        } else if (sp.isBannato()) {</span>
<span class="nc" id="L82">            throw new RuntimeException403(&quot;Sei stato bannato da questa stanza, non puoi entrare&quot;);</span>
        } else {
<span class="nc" id="L84">            return ResponseEntity.ok(new AccessResponse&lt;&gt;(stanza.getId(), &quot;Sei già all'interno di questa stanza&quot;, false));</span>
        }
    }

    /**
     *
     * @param IdStanza
     * @param metaId
     * @param IdUtente
     * @return
     * @throws ServerRuntimeException
     * @throws RuntimeException403
     */
    @Override
    public ResponseEntity&lt;Response&lt;Boolean&gt;&gt; banUtente(Long IdStanza, String metaId, Long IdUtente)  throws ServerRuntimeException, RuntimeException403 {
        Utente ogm;
<span class="nc bnc" id="L100" title="All 2 branches missed.">        if((ogm = utenteRepository.findFirstByMetaId(metaId))==null)</span>
<span class="nc" id="L101">            throw new ServerRuntimeException(&quot;errore nella ricerca dell'organizzatore master&quot;);</span>

        //controllo organizzatore da bannare
        Utente og;
<span class="nc bnc" id="L105" title="All 2 branches missed.">        if((og=utenteRepository.findUtenteById(IdUtente))==null)</span>
<span class="nc" id="L106">            throw new RuntimeException403(&quot;utente non trovato&quot;);</span>

        //controllo stanza
        Stanza stanza;
<span class="nc bnc" id="L110" title="All 2 branches missed.">        if((stanza = stanzaRepository.findStanzaById(IdStanza))==null)</span>
<span class="nc" id="L111">            throw new RuntimeException403(&quot;stanza non trovata&quot;);</span>

<span class="nc" id="L113">        StatoPartecipazione stato_og = statoPartecipazioneRepository</span>
<span class="nc" id="L114">                .findStatoPartecipazioneByUtenteAndStanza(og, stanza);</span>
<span class="nc bnc" id="L115" title="All 2 branches missed.">        if(stato_og==null)</span>
<span class="nc" id="L116">            throw new RuntimeException403(&quot;L'utente non ha acceduto alla stanza, forse è stato kickato&quot;);</span>

<span class="nc bnc" id="L118" title="All 2 branches missed.">        if(stato_og.getRuolo().getNome().equalsIgnoreCase(Ruolo.ORGANIZZATORE)){</span>
<span class="nc" id="L119">            return banOrganizzatore(IdStanza, metaId, IdUtente);</span>
<span class="nc bnc" id="L120" title="All 2 branches missed.">        }else if((stato_og.getRuolo().getNome().equalsIgnoreCase(Ruolo.PARTECIPANTE))){</span>
<span class="nc" id="L121">            return banPartecipante(IdStanza, metaId, IdUtente);</span>
        }else{
<span class="nc" id="L123">            return ResponseEntity.ok(new Response&lt;&gt;(false, &quot;Non puoi bannare un'organizzatore master&quot;));</span>
        }
    }

    /**
     *
     * @param IdStanza
     * @param metaId
     * @param IdUtente
     * @return
     * @throws ServerRuntimeException
     * @throws RuntimeException403
     */
    @Override
    public ResponseEntity&lt;Response&lt;Boolean&gt;&gt; banOrganizzatore(Long IdStanza, String metaId, Long IdUtente)  throws ServerRuntimeException, RuntimeException403 {
        //controllo organizzatore master
            Utente ogm;
<span class="nc bnc" id="L140" title="All 2 branches missed.">            if((ogm = utenteRepository.findFirstByMetaId(metaId))==null)</span>
<span class="nc" id="L141">                throw new ServerRuntimeException(&quot;errore nella ricerca dell'organizzatore master&quot;);</span>

            //controllo organizzatore da bannare
            Utente og;
<span class="nc bnc" id="L145" title="All 2 branches missed.">            if((og=utenteRepository.findUtenteById(IdUtente))==null)</span>
<span class="nc" id="L146">                throw new RuntimeException403(&quot;utente non trovato&quot;);</span>

            //controllo stanza
            Stanza stanza;
<span class="nc bnc" id="L150" title="All 2 branches missed.">            if((stanza = stanzaRepository.findStanzaById(IdStanza))==null)</span>
<span class="nc" id="L151">                throw new RuntimeException403(&quot;stanza non trovata&quot;);</span>

            //controllo dell'accesso dell'organizzatore master nella stanza
<span class="nc" id="L154">        StatoPartecipazione stato_ogm = statoPartecipazioneRepository</span>
<span class="nc" id="L155">                .findStatoPartecipazioneByUtenteAndStanza(ogm, stanza);</span>
<span class="nc bnc" id="L156" title="All 2 branches missed.">        if(stato_ogm==null)  throw new ServerRuntimeException(&quot;l'organizzatore master sembra &quot;+</span>
                &quot;non aver acceduto alla stanza&quot;);

        //controllo del ruolo di organizztaore master
<span class="nc bnc" id="L160" title="All 2 branches missed.">        if (stato_ogm.getRuolo().getNome().equalsIgnoreCase(Ruolo.ORGANIZZATORE_MASTER)) {</span>

            //ricerco e controllo se l'organizzatore ha fatto accesso alla stanza
<span class="nc" id="L163">            StatoPartecipazione stato_og = statoPartecipazioneRepository</span>
<span class="nc" id="L164">                    .findStatoPartecipazioneByUtenteAndStanza(og, stanza);</span>
<span class="nc bnc" id="L165" title="All 2 branches missed.">            if(stato_og==null)</span>
<span class="nc" id="L166">                throw new RuntimeException403(&quot;L'utente non ha acceduto alla stanza, forse è stato kickato&quot;);</span>

            //verifico se l'organizzatore è in attesa
<span class="nc bnc" id="L169" title="All 2 branches missed.">            if(stato_og.isInAttesa())</span>
<span class="nc" id="L170">                throw new RuntimeException403(&quot;L'utente è in attesa di entrare in stanza, non può essere bannato&quot;);</span>

            //verifico se l'organizzatore è  già bannato
<span class="nc bnc" id="L173" title="All 2 branches missed.">            if(stato_og.isBannato())</span>
<span class="nc" id="L174">                throw new RuntimeException403(&quot;L'utente selezionato è già bannato!&quot;);</span>

            //se è organizzatpre allora posso bannarlo
<span class="nc" id="L177">            stato_og.setBannato(true);</span>
<span class="nc" id="L178">            statoPartecipazioneRepository.save(stato_og);</span>

<span class="nc" id="L180">            return ResponseEntity.ok(new Response&lt;&gt;(true, &quot;L'organizzatore selezionato ora è bannato&quot;));</span>

        }else{
<span class="nc" id="L183">            throw new RuntimeException403(&quot;Non puoi bannare un'organizzatore se non sei un organizzatore master&quot;);</span>
        }
    }

    /**
     *
     * @param IdStanza
     * @param metaId
     * @param IdUtente
     * @return
     * @throws ServerRuntimeException
     * @throws RuntimeException403
     */
    @Override
    public ResponseEntity&lt;Response&lt;Boolean&gt;&gt; banPartecipante(Long IdStanza, String metaId, Long IdUtente) throws ServerRuntimeException, RuntimeException403 {
        //controllo organizzatore master
        Utente ogm;
<span class="nc bnc" id="L200" title="All 2 branches missed.">        if((ogm = utenteRepository.findFirstByMetaId(metaId))==null)</span>
<span class="nc" id="L201">            throw new ServerRuntimeException(&quot;errore nella ricerca dell'organizzatore master&quot;);</span>

        //controllo organizzatore da bannare
        Utente og;
<span class="nc bnc" id="L205" title="All 2 branches missed.">        if((og=utenteRepository.findUtenteById(IdUtente))==null)</span>
<span class="nc" id="L206">            throw new RuntimeException403(&quot;utente non trovato&quot;);</span>

        //controllo stanza
        Stanza stanza;
<span class="nc bnc" id="L210" title="All 2 branches missed.">        if((stanza = stanzaRepository.findStanzaById(IdStanza))==null)</span>
<span class="nc" id="L211">            throw new RuntimeException403(&quot;stanza non trovata&quot;);</span>

        //controllo dell'accesso dell'organizzatore master nella stanza
<span class="nc" id="L214">        StatoPartecipazione stato_ogm = statoPartecipazioneRepository</span>
<span class="nc" id="L215">                .findStatoPartecipazioneByUtenteAndStanza(ogm, stanza);</span>
<span class="nc bnc" id="L216" title="All 2 branches missed.">        if(stato_ogm==null)  throw new ServerRuntimeException(&quot;l'organizzatore master sembra &quot;+</span>
                &quot;non aver acceduto alla stanza&quot;);

        //controllo del ruolo di organizztaore
<span class="nc bnc" id="L220" title="All 4 branches missed.">        if (stato_ogm.getRuolo().getNome().equalsIgnoreCase(Ruolo.ORGANIZZATORE_MASTER) || stato_ogm.getRuolo().getNome().equalsIgnoreCase(Ruolo.ORGANIZZATORE)) {</span>
            //ricerco e controllo se l'organizzatore ha fatto accesso alla stanza
<span class="nc" id="L222">            StatoPartecipazione stato_og = statoPartecipazioneRepository</span>
<span class="nc" id="L223">                    .findStatoPartecipazioneByUtenteAndStanza(og, stanza);</span>
<span class="nc bnc" id="L224" title="All 2 branches missed.">            if(stato_og==null)   throw new RuntimeException403(&quot;L'utente non ha acceduto alla stanza, forse è stato kickato&quot;);</span>

            //verifico se l'utente è in attesa
<span class="nc bnc" id="L227" title="All 2 branches missed.">            if(stato_og.isInAttesa())</span>
<span class="nc" id="L228">                throw new RuntimeException403(&quot;L'utente è in attesa di entrare in stanza, non può essere bannato&quot;);</span>

            //verifico se l'utente è già bannato
<span class="nc bnc" id="L231" title="All 2 branches missed.">            if(stato_og.isBannato())</span>
<span class="nc" id="L232">                throw new RuntimeException403(&quot;L'utente selezionato è già bannato!&quot;);</span>

<span class="nc" id="L234">            stato_og.setBannato(true);</span>
<span class="nc" id="L235">            statoPartecipazioneRepository.save(stato_og);</span>
<span class="nc" id="L236">            return ResponseEntity.ok(new Response&lt;&gt;(true, &quot;L'utente selezionato ora è bannato&quot;));</span>

        }else{
<span class="nc" id="L239">            throw new RuntimeException403(&quot;Non puoi bannare un'utente perché &quot; +</span>
                    &quot;non sei almeno un organizzatore&quot;);
        }
    }

    /**
     *
     * @param s
     * @param metaID
     * @return
     * @throws Exception
     */
    @Override
    public boolean creaStanza(Stanza s, String metaID) throws Exception {

<span class="nc bnc" id="L254" title="All 2 branches missed.">        if (metaID == null)</span>
<span class="nc" id="L255">            throw new ServerRuntimeException(&quot;Errore col metaID&quot;);</span>

<span class="nc" id="L257">        Utente u = utenteRepository.findFirstByMetaId(metaID);</span>
<span class="nc bnc" id="L258" title="All 2 branches missed.">        if (u == null)</span>
<span class="nc" id="L259">            throw new ServerRuntimeException(&quot;Utente non trovato&quot;);</span>

        //settaggio scenario
<span class="nc" id="L262">        Scenario sc = scenarioRepository.findScenarioById(s.getScenario().getId());</span>
<span class="nc bnc" id="L263" title="All 2 branches missed.">        if (sc != null)</span>
<span class="nc" id="L264">            s.setScenario(sc);</span>
        else
<span class="nc" id="L266">            throw new RuntimeException403(&quot;Scenario non trovato&quot;);</span>

<span class="nc" id="L268">        stanzaRepository.save(s);</span>

        //Prelevo l'id della stanza a cui si deve generare il codice
<span class="nc" id="L271">        Long id_stanza = stanzaRepository.findIdUltimaTupla();</span>
        //Converto l'id in una stringa di 6 caratteri
<span class="nc" id="L273">        String codice = String.format(&quot;%06d&quot;, id_stanza);</span>
<span class="nc" id="L274">        s.setCodice(codice);</span>
<span class="nc" id="L275">        stanzaRepository.save(s);</span>

<span class="nc" id="L277">       StatoPartecipazione sp = new StatoPartecipazione(s, u,</span>
<span class="nc" id="L278">              ruoloRepository.findByNome(Ruolo.ORGANIZZATORE_MASTER), false, false, u.getNome(), true);</span>

<span class="nc" id="L280">       statoPartecipazioneRepository.save(sp);</span>

<span class="nc" id="L282">        return true;</span>
    }

    /**
     *
     * @param id_Uogm
     * @param id_og
     * @param id_stanza
     * @return
     * @throws ServerRuntimeException
     * @throws RuntimeException403
     */
    @Override
    public Response&lt;Boolean&gt; downgradeUtente(String id_Uogm, long id_og, long id_stanza) throws ServerRuntimeException, RuntimeException403 {

        //controllo organizzatore master
        Utente ogm;
<span class="nc bnc" id="L299" title="All 2 branches missed.">        if((ogm = utenteRepository.findFirstByMetaId(id_Uogm))==null)</span>
<span class="nc" id="L300">            throw new ServerRuntimeException(&quot;errore nella ricerca dell'organizzatore master&quot;);</span>

        //controllo utente da promuovere
        Utente og;
<span class="nc bnc" id="L304" title="All 2 branches missed.">        if((og=utenteRepository.findUtenteById(id_og))==null)</span>
<span class="nc" id="L305">            throw new RuntimeException403(&quot;utente non trovato&quot;);</span>

        //controllo stanza
        Stanza stanza;
<span class="nc bnc" id="L309" title="All 2 branches missed.">        if((stanza = stanzaRepository.findStanzaById(id_stanza))==null)</span>
<span class="nc" id="L310">            throw new RuntimeException403(&quot;stanza non trovata&quot;);</span>

        //controllo dell'accesso dell'organizzatore master nella stanza
<span class="nc" id="L313">        StatoPartecipazione stato_ogm = statoPartecipazioneRepository</span>
<span class="nc" id="L314">                .findStatoPartecipazioneByUtenteAndStanza(ogm, stanza);</span>
<span class="nc bnc" id="L315" title="All 2 branches missed.">        if(stato_ogm==null)  throw new ServerRuntimeException(&quot;l'organizzatore master sembra &quot;+</span>
                &quot;non aver acceduto alla stanza&quot;);

        //controllo del ruolo di organizztaore master
<span class="nc bnc" id="L319" title="All 2 branches missed.">        if (!stato_ogm.getRuolo().getNome().equalsIgnoreCase(Ruolo.ORGANIZZATORE_MASTER)) {</span>
<span class="nc" id="L320">            throw new RuntimeException403(&quot;Non puoi declassare un'utente perché &quot; +</span>
                    &quot;non sei un'organizzatore master&quot;);
        }

        //ricerco e controllo se l'utente ha fatto accesso alla stanza
<span class="nc" id="L325">        StatoPartecipazione stato_og = statoPartecipazioneRepository</span>
<span class="nc" id="L326">                .findStatoPartecipazioneByUtenteAndStanza(og, stanza);</span>
<span class="nc bnc" id="L327" title="All 2 branches missed.">        if(stato_og==null)   throw new RuntimeException403(&quot;l'utente non ha acceduto alla stanza, forse è stato kickato&quot;);</span>

        //verifico se l'utente è in attesa
<span class="nc bnc" id="L330" title="All 2 branches missed.">        if(stato_og.isInAttesa())</span>
<span class="nc" id="L331">            throw new RuntimeException403(&quot;l'utente è in attesa di entrare in stanza, non può essere declassato&quot;);</span>

        //verifico se l'utente è bannato
<span class="nc bnc" id="L334" title="All 2 branches missed.">        if(stato_og.isBannato())</span>
<span class="nc" id="L335">            throw new RuntimeException403(&quot;l'utente è bannato, non può essere promosso&quot;);</span>

        //verifico il ruolo dell'utente nella stanza
<span class="nc bnc" id="L338" title="All 2 branches missed.">        if (stato_og.getRuolo().getNome().equalsIgnoreCase(Ruolo.ORGANIZZATORE)) {</span>

            //se è organizzatpre allora posso declassarlo a partecipante
<span class="nc" id="L341">            Ruolo r = ruoloRepository.findByNome(Ruolo.PARTECIPANTE);</span>
<span class="nc" id="L342">            stato_og.setRuolo(r);</span>
<span class="nc" id="L343">            statoPartecipazioneRepository.save(stato_og);</span>

<span class="nc" id="L345">            return ResponseEntity.ok(new Response&lt;&gt;(true, &quot;L'utente selezionato ora è un partecipante&quot;)).getBody();</span>

<span class="nc bnc" id="L347" title="All 2 branches missed.">        } else if (stato_og.getRuolo().getNome().equalsIgnoreCase(Ruolo.PARTECIPANTE)) {</span>
<span class="nc" id="L348">            throw new RuntimeException403(&quot;L'utente selezionato è già un partecipante&quot;);</span>
        } else {
<span class="nc" id="L350">            throw new RuntimeException403(&quot;Sembra sia stato inviato un organizzatore master&quot;);</span>
        }
    }

    /**
     *
     * @param metaID
     * @param id_stanza
     * @return
     */
    @Override
    public Response&lt;Boolean&gt; deleteRoom(String metaID, Long id_stanza) {

<span class="nc" id="L363">        Utente ogm = utenteRepository.findFirstByMetaId(metaID);</span>
<span class="nc" id="L364">        Stanza stanza = stanzaRepository.findStanzaById(id_stanza);</span>
<span class="nc bnc" id="L365" title="All 2 branches missed.">        if (stanza == null) {</span>
<span class="nc" id="L366">            return ResponseUtils.getResponseError(HttpStatus.INTERNAL_SERVER_ERROR, &quot;La stanza selezionata non esiste&quot;).getBody();</span>
        }

<span class="nc" id="L369">        StatoPartecipazione stato_ogm = statoPartecipazioneRepository.findStatoPartecipazioneByUtenteAndStanza(ogm, stanza);</span>
<span class="nc bnc" id="L370" title="All 4 branches missed.">        if (stato_ogm.getRuolo().getNome().equalsIgnoreCase(Ruolo.ORGANIZZATORE_MASTER) || ogm.isAdmin()) {</span>
                //elimina tutti gli stati partecipazione
<span class="nc" id="L372">                statoPartecipazioneRepository.deleteAllByStanza(stanza);</span>
                //elimina stanza
<span class="nc" id="L374">                stanzaRepository.delete(stanza);</span>
<span class="nc" id="L375">            return ResponseEntity.ok(new Response&lt;&gt;(true, &quot;Stanza eliminata con successo&quot;)).getBody();</span>
        } else {
<span class="nc" id="L377">            return ResponseEntity.status(403).body(new Response&lt;&gt;(false, &quot;Non puoi eliminare una stanza se non sei un'organizzatore master&quot;)).getBody();</span>
        }
    }

    /**
     *
     * @param metaID
     * @param idUtente
     * @param idStanza
     * @param scelta
     * @return
     */
    @Override
    public ResponseEntity&lt;Response&lt;Boolean&gt;&gt; gestioneAccesso(String metaID, Long idUtente, Long idStanza, boolean scelta) {

<span class="nc" id="L392">        Utente og = utenteRepository.findFirstByMetaId(metaID);</span>
<span class="nc" id="L393">        Utente accesso = utenteRepository.findUtenteById(idUtente);</span>
<span class="nc" id="L394">        Stanza stanza = stanzaRepository.findStanzaById(idStanza);</span>

<span class="nc bnc" id="L396" title="All 2 branches missed.">        if(stanza != null) {</span>
<span class="nc" id="L397">            StatoPartecipazione statoOg = statoPartecipazioneRepository.findStatoPartecipazioneByUtenteAndStanza(og, stanza);</span>
<span class="nc bnc" id="L398" title="All 6 branches missed.">            if (statoOg.getRuolo().getNome().equalsIgnoreCase(Ruolo.ORGANIZZATORE_MASTER) || statoOg.getRuolo().getNome().equalsIgnoreCase(Ruolo.ORGANIZZATORE) &amp;&amp; !statoOg.isBannato()) {</span>
<span class="nc" id="L399">                StatoPartecipazione statoAccesso = statoPartecipazioneRepository.findStatoPartecipazioneByUtenteAndStanza(accesso, stanza);</span>
<span class="nc bnc" id="L400" title="All 2 branches missed.">                if (statoAccesso.isInAttesa()) {</span>
<span class="nc bnc" id="L401" title="All 2 branches missed.">                    if (scelta) {</span>
<span class="nc" id="L402">                        statoAccesso.setInAttesa(false);</span>
<span class="nc" id="L403">                        statoPartecipazioneRepository.save(statoAccesso);</span>
<span class="nc" id="L404">                        return ResponseEntity.ok(new Response&lt;&gt;(true, &quot;L'utente selezionato non è più in attesa e sta per entrare nella stanza&quot;));</span>
                    } else {
<span class="nc" id="L406">                        statoPartecipazioneRepository.delete(statoAccesso);</span>
<span class="nc" id="L407">                        return ResponseEntity.ok(new Response&lt;&gt;(true, &quot;L'utente selezionato non è più in attesa, hai rifiutato la richiesta di accesso alla stanza&quot;));</span>
                    }
                } else {
<span class="nc" id="L410">                    return ResponseEntity.status(403).body(new Response&lt;&gt;(false, &quot;L'utente selezioanto non è in attesa di entrare in questa stanza&quot;));</span>
                }
            }else{
<span class="nc" id="L413">                return ResponseEntity.status(403).body(new Response&lt;&gt;(false, &quot;Per accettare o rifiutare richiesta di accesso alla stanza devi essere almeno un organizzatore&quot;));</span>
            }
        }else{
<span class="nc" id="L416">            return ResponseEntity.status(403).body(new Response&lt;&gt;(false, &quot;La stanza selezionata non esiste&quot;));</span>
        }
    }

    /**
     *
     * @param metaID
     * @param IdStanza
     * @param IdUtente
     * @return
     */
    @Override
    public ResponseEntity&lt;Response&lt;Boolean&gt;&gt; SilenziaPartecipante(String metaID, Long IdStanza, Long IdUtente) {

<span class="nc" id="L430">        Utente og = utenteRepository.findFirstByMetaId(metaID);</span>
<span class="nc" id="L431">        Utente silenzia = utenteRepository.findUtenteById(IdUtente);</span>
<span class="nc" id="L432">        Stanza stanza = stanzaRepository.findStanzaById(IdStanza);</span>

<span class="nc bnc" id="L434" title="All 2 branches missed.">        if(stanza != null) {</span>
<span class="nc" id="L435">            StatoPartecipazione statoOg = statoPartecipazioneRepository.findStatoPartecipazioneByUtenteAndStanza(og, stanza);</span>
<span class="nc bnc" id="L436" title="All 6 branches missed.">            if (statoOg.getRuolo().getNome().equalsIgnoreCase(Ruolo.ORGANIZZATORE_MASTER) || statoOg.getRuolo().getNome().equalsIgnoreCase(Ruolo.ORGANIZZATORE) &amp;&amp; !statoOg.isBannato()) {</span>
<span class="nc" id="L437">                StatoPartecipazione statoSilenzio = statoPartecipazioneRepository.findStatoPartecipazioneByUtenteAndStanza(silenzia, stanza);</span>
<span class="nc bnc" id="L438" title="All 2 branches missed.">                if (statoSilenzio != null) {</span>
<span class="nc bnc" id="L439" title="All 2 branches missed.">                    if (!statoSilenzio.isSilenziato()) {</span>
<span class="nc" id="L440">                        statoSilenzio.setSilenziato(true);</span>
<span class="nc" id="L441">                        statoPartecipazioneRepository.save(statoSilenzio);</span>
<span class="nc" id="L442">                        return ResponseEntity.ok(new Response&lt;&gt;(true, &quot;L'utente selezionato ora è silenziato&quot;));</span>
                    } else {
<span class="nc" id="L444">                        return ResponseEntity.ok(new Response&lt;&gt;(true, &quot;L'utente selezionato è gia silenziato&quot;));</span>
                    }
                } else {
<span class="nc" id="L447">                    return ResponseEntity.status(403).body(new Response&lt;&gt;(false, &quot;L'utente selezioanto non è presente nella stanza&quot;));</span>
                }
            }else{
<span class="nc" id="L450">                return ResponseEntity.status(403).body(new Response&lt;&gt;(false, &quot;Per silenziare un partecipante nella stanza devi essere almeno un organizzatore&quot;));</span>
            }
        }else{
<span class="nc" id="L453">            return ResponseEntity.status(403).body(new Response&lt;&gt;(false, &quot;La stanza selezionata non esiste&quot;));</span>
        }
    }

    /**
     *
     * @param params
     * @param id
     * @return
     * @throws RuntimeException403
     * @throws RuntimeException401
     */
    @Override
    public Boolean modificaDatiStanza(Map&lt;String, Object&gt; params, Long id) throws RuntimeException403, RuntimeException401 {

        //controllo del ruolo di ogm
<span class="nc" id="L469">        String metaID = jwtTokenUtil.getMetaIdFromToken(validationToken.getToken());</span>
<span class="nc" id="L470">        Utente ogm = utenteRepository.findFirstByMetaId(metaID);</span>
<span class="nc" id="L471">        Stanza existingStanza = stanzaRepository.findStanzaById(id);</span>

<span class="nc bnc" id="L473" title="All 2 branches missed.">        if (existingStanza == null) {</span>
<span class="nc" id="L474">            throw new RuntimeException403(&quot;La stanza non esiste&quot;);</span>
        }

<span class="nc" id="L477">        StatoPartecipazione statoutente = statoPartecipazioneRepository.</span>
<span class="nc" id="L478">                findStatoPartecipazioneByUtenteAndStanza(ogm, existingStanza);</span>

<span class="nc bnc" id="L480" title="All 2 branches missed.">        if (statoutente == null) throw new RuntimeException403(&quot;Non hai acceduto alla stanza&quot;);</span>

<span class="nc bnc" id="L482" title="All 2 branches missed.">        if (!statoutente.getRuolo().getNome().equalsIgnoreCase(Ruolo.PARTECIPANTE)) {</span>
<span class="nc bnc" id="L483" title="All 2 branches missed.">            return stanzaRepository.updateAttributes(id, params) &gt; 0;</span>
        } else {
<span class="nc" id="L485">            throw new RuntimeException401(&quot;devi essere almeno un organizzatore&quot;);</span>
        }
    }

    /**
     *
     * @param id
     * @return
     */
    @Override
    public ResponseEntity&lt;Response&lt;Scenario&gt;&gt; findStanza(Long id) {
<span class="nc" id="L496">        Stanza stanza = stanzaRepository.findStanzaById(id);</span>

<span class="nc bnc" id="L498" title="All 2 branches missed.">        if (stanza == null) {</span>
<span class="nc" id="L499">            return ResponseEntity.status(500)</span>
<span class="nc" id="L500">                    .body(new Response&lt;&gt;(null, &quot;La stanza selezionata non esiste&quot;));</span>
        } else {

<span class="nc" id="L503">            return ResponseEntity</span>
<span class="nc" id="L504">                    .ok(new Response&lt;&gt;(stanza.getScenario(), &quot;operazione effettuata con successo&quot;));</span>
        }
    }

    /**
     *
     * @param id_Uogm
     * @param id_og
     * @param id_stanza
     * @return
     * @throws ServerRuntimeException
     * @throws RuntimeException403
     */
    @Override
    public Response&lt;Boolean&gt; upgradeUtente(String id_Uogm, long id_og, long id_stanza) throws ServerRuntimeException, RuntimeException403 {

        //controllo organizzatore master
        Utente ogm;
<span class="nc bnc" id="L522" title="All 2 branches missed.">        if((ogm = utenteRepository.findFirstByMetaId(id_Uogm))==null)</span>
<span class="nc" id="L523">            throw new ServerRuntimeException(&quot;errore nella ricerca dell'organizzatore master&quot;);</span>

        //controllo utente da promuovere
        Utente og;
<span class="nc bnc" id="L527" title="All 2 branches missed.">        if((og=utenteRepository.findUtenteById(id_og))==null)</span>
<span class="nc" id="L528">            throw new RuntimeException403(&quot;utente non trovato&quot;);</span>

        //controllo stanza
        Stanza stanza;
<span class="nc bnc" id="L532" title="All 2 branches missed.">        if((stanza = stanzaRepository.findStanzaById(id_stanza))==null)</span>
<span class="nc" id="L533">            throw new RuntimeException403(&quot;stanza non trovata&quot;);</span>

        //controllo dell'accesso dell'organizzatore master nella stanza
<span class="nc" id="L536">        StatoPartecipazione stato_ogm = statoPartecipazioneRepository</span>
<span class="nc" id="L537">                .findStatoPartecipazioneByUtenteAndStanza(ogm, stanza);</span>
<span class="nc bnc" id="L538" title="All 2 branches missed.">        if(stato_ogm==null)  throw new ServerRuntimeException(&quot;l'organizzatore master sembra &quot;+</span>
                &quot;non aver acceduto alla stanza&quot;);

        //controllo del ruolo di organizztaore master
<span class="nc bnc" id="L542" title="All 2 branches missed.">        if (!stato_ogm.getRuolo().getNome().equalsIgnoreCase(Ruolo.ORGANIZZATORE_MASTER)) {</span>
<span class="nc" id="L543">              throw new RuntimeException403(&quot;Non puoi promuovere un'utente perché &quot; +</span>
                      &quot;non sei un'organizzatore master&quot;);
        }

        //ricerco e controllo se l'utente ha fatto accesso alla stanza
<span class="nc" id="L548">        StatoPartecipazione stato_og = statoPartecipazioneRepository</span>
<span class="nc" id="L549">                .findStatoPartecipazioneByUtenteAndStanza(og, stanza);</span>
<span class="nc bnc" id="L550" title="All 2 branches missed.">        if(stato_og==null)   throw new RuntimeException403(&quot;l'utente non ha acceduto alla stanza, magari è stato kickato&quot;);</span>

        //verifico se l'utente è in attesa
<span class="nc bnc" id="L553" title="All 2 branches missed.">        if(stato_og.isInAttesa())</span>
<span class="nc" id="L554">            throw new RuntimeException403(&quot;l'utente è in attesa di entrare in stanza, non può essere promosso&quot;);</span>

        //verifico se l'utente è bannato
<span class="nc bnc" id="L557" title="All 2 branches missed.">        if(stato_og.isBannato())</span>
<span class="nc" id="L558">            throw new RuntimeException403(&quot;l'utente è bannato, non può essere promosso&quot;);</span>

        //verifico il ruolo dell'utente nella stanza
<span class="nc bnc" id="L561" title="All 2 branches missed.">        if (stato_og.getRuolo().getNome().equalsIgnoreCase(Ruolo.PARTECIPANTE)) {</span>

                //se è partecipante allora posso promuoverlo ad organizzatore
<span class="nc" id="L564">                Ruolo r = ruoloRepository.findByNome(Ruolo.ORGANIZZATORE);</span>
<span class="nc" id="L565">                stato_og.setRuolo(r);</span>
<span class="nc" id="L566">                statoPartecipazioneRepository.save(stato_og);</span>

<span class="nc" id="L568">                return ResponseEntity.ok(new Response&lt;&gt;(true, &quot;L'utente selezionato ora è un organizzatore&quot;)).getBody();</span>

<span class="nc bnc" id="L570" title="All 2 branches missed.">            } else if (stato_og.getRuolo().getNome().equalsIgnoreCase(Ruolo.ORGANIZZATORE)) {</span>
<span class="nc" id="L571">                  throw new RuntimeException403(&quot;L'utente selezionato è già un'organizzatore&quot;);</span>
            } else {
<span class="nc" id="L573">                  throw new RuntimeException403(&quot;Sembra sia stato inviato un organizzatore master&quot;);</span>
            }

    }

    /**
     *
     * @param Id
     * @return
     */
    @Override
    public ResponseEntity&lt;Response&lt;List&lt;Utente&gt;&gt;&gt; visualizzaUtentiInStanza(Long Id) {

<span class="nc" id="L586">        Stanza stanza = stanzaRepository.findStanzaById(Id);</span>

<span class="nc bnc" id="L588" title="All 2 branches missed.">        if (stanza != null) {</span>
<span class="nc" id="L589">            List&lt;Utente&gt; utenti = statoPartecipazioneRepository.findUtentiInStanza(Id);</span>
<span class="nc bnc" id="L590" title="All 2 branches missed.">            if (utenti != null) {</span>
<span class="nc" id="L591">                return ResponseEntity.ok(new Response&lt;&gt;</span>
                        (utenti, &quot;operazione effettuata con successo&quot;));
            } else {
<span class="nc" id="L594">                return ResponseEntity.ok(new Response&lt;&gt;(null, &quot;Non sono presenti utenti all'interno della stanza&quot;));</span>
            }
        } else {
<span class="nc" id="L597">            return ResponseEntity.status(403).body(new Response&lt;&gt;(null, &quot;La stanza selezionata non esiste&quot;));</span>
        }
    }

    /**
     *
     * @param Id
     * @return
     */
    @Override
    public ResponseEntity&lt;Response&lt;List&lt;Utente&gt;&gt;&gt; visualizzaUtentiBannatiInStanza(Long Id) {

<span class="nc" id="L609">        Stanza stanza = stanzaRepository.findStanzaById(Id);</span>

<span class="nc bnc" id="L611" title="All 2 branches missed.">        if (stanza != null) {</span>
<span class="nc" id="L612">            List&lt;Utente&gt; utenti = statoPartecipazioneRepository.findUtentiBannatiInStanza(Id);</span>
<span class="nc bnc" id="L613" title="All 2 branches missed.">            if (utenti != null) {</span>
<span class="nc" id="L614">                return ResponseEntity.ok(new Response&lt;&gt;</span>
                        (utenti, &quot;operazione effettuata con successo&quot;));
            } else {
<span class="nc" id="L617">                return ResponseEntity.ok(new Response&lt;&gt;(null, &quot;Non sono presenti utenti bannati all'interno della stanza&quot;));</span>
            }
        } else {
<span class="nc" id="L620">            return ResponseEntity.status(403).body(new Response&lt;&gt;(null, &quot;La stanza selezionata non esiste&quot;));</span>
        }
    }

    /**
     *
     * @param Id
     * @param metaID
     * @return
     */
    @Override
    public ResponseEntity&lt;Response&lt;List&lt;Utente&gt;&gt;&gt; visualizzaUtentiInAttesaInStanza(Long Id, String metaID) {
<span class="nc" id="L632">        Stanza stanza = stanzaRepository.findStanzaById(Id);</span>
<span class="nc" id="L633">        Utente u = utenteRepository.findFirstByMetaId(metaID);</span>
<span class="nc bnc" id="L634" title="All 2 branches missed.">        if (stanza != null) {</span>
<span class="nc" id="L635">            StatoPartecipazione stato = statoPartecipazioneRepository.findStatoPartecipazioneByUtenteAndStanza(u, stanza);</span>
<span class="nc bnc" id="L636" title="All 2 branches missed.">            if (stato != null) {</span>
<span class="nc bnc" id="L637" title="All 6 branches missed.">                if (stato.getRuolo().getNome().equalsIgnoreCase(Ruolo.ORGANIZZATORE_MASTER) || stato.getRuolo().getNome().equalsIgnoreCase(Ruolo.ORGANIZZATORE) &amp;&amp; !stato.isBannato()) {</span>
<span class="nc" id="L638">                    List&lt;Utente&gt; utenti = statoPartecipazioneRepository.findUtentiInAttesaInStanza(Id);</span>

<span class="nc bnc" id="L640" title="All 2 branches missed.">                    if (utenti != null) {</span>
<span class="nc" id="L641">                        return ResponseEntity.ok(new Response&lt;&gt;</span>
                                (utenti, &quot;operazione effettuata con successo&quot;));
                    } else {
<span class="nc" id="L644">                        return ResponseEntity.ok(new Response&lt;&gt;(null, &quot;Non sono presenti utenti in attesa all'interno della stanza&quot;));</span>
                    }
                } else {
<span class="nc" id="L647">                    return ResponseEntity.status(403).body(new Response&lt;&gt;(null, &quot;Non puoi visualizzare gli utenti in attesa se non sei almeno un organizzatore&quot;));</span>
                }
            } else {
<span class="nc" id="L650">                return ResponseEntity.status(403).body(new Response&lt;&gt;(null, &quot;Non puoi visualizzare gli utenti in attesa della stanza se non sei almeno un'organizzatore di essa&quot;));</span>
            }
        } else {
<span class="nc" id="L653">            return ResponseEntity.status(403).body(new Response&lt;&gt;(null, &quot;La stanza selezionata non esiste&quot;));</span>
        }
    }

    /**
     *
     * @param metaID
     * @param idScenario
     * @param idStanza
     * @return
     */
    @Override
    public ResponseEntity&lt;Response&lt;Boolean&gt;&gt; modificaScenario(String metaID, Long idScenario, Long idStanza) {
<span class="nc" id="L666">        Utente u = utenteRepository.findFirstByMetaId(metaID);</span>
<span class="nc" id="L667">        Stanza stanza = stanzaRepository.findStanzaById(idStanza);</span>

<span class="nc bnc" id="L669" title="All 2 branches missed.">        if (stanza != null) {</span>
<span class="nc" id="L670">            StatoPartecipazione stato = statoPartecipazioneRepository.findStatoPartecipazioneByUtenteAndStanza(u, stanza);</span>
<span class="nc bnc" id="L671" title="All 2 branches missed.">            if (stato != null) {</span>
<span class="nc bnc" id="L672" title="All 6 branches missed.">                if (stato.getRuolo().getNome().equalsIgnoreCase(Ruolo.ORGANIZZATORE_MASTER) || stato.getRuolo().getNome().equalsIgnoreCase(Ruolo.ORGANIZZATORE) &amp;&amp; !stato.isBannato()) {</span>
<span class="nc" id="L673">                    Scenario scenario = scenarioRepository.findScenarioById(idScenario);</span>
<span class="nc bnc" id="L674" title="All 2 branches missed.">                    if (scenario != null) {</span>
<span class="nc bnc" id="L675" title="All 2 branches missed.">                        if (scenario != stanza.getScenario()) {</span>
<span class="nc" id="L676">                            stanza.setScenario(scenario);</span>
<span class="nc" id="L677">                            stanzaRepository.save(stanza);</span>
<span class="nc" id="L678">                            return ResponseEntity.ok(new Response&lt;&gt;(true, &quot;Lo scenario è stato modificato&quot;));</span>
                        } else {
<span class="nc" id="L680">                            return ResponseEntity.status(403).body(new Response&lt;&gt;(false, &quot;Lo scenario selezionato è già in uso per la stanza&quot;));</span>
                        }
                    } else {
<span class="nc" id="L683">                        return ResponseEntity.status(403).body(new Response&lt;&gt;(false, &quot;Lo scenario selezionato non esiste&quot;));</span>
                    }
                } else {
<span class="nc" id="L686">                    return ResponseEntity.status(403).body(new Response&lt;&gt;(false, &quot;Non puoi modificare lo scenario se non sei almeno un organizzatore&quot;));</span>
                }
            } else {
<span class="nc" id="L689">                return ResponseEntity.status(403).body(new Response&lt;&gt;(false, &quot;Non sei all'interno della stanza, non puoi modificare lo scenario&quot;));</span>
            }

        } else {
<span class="nc" id="L693">            return ResponseEntity.status(403).body(new Response&lt;&gt;(false, &quot;La stanza selezionata non esiste&quot;));</span>
        }

    }

    /**
     *
     * @param metaID
     * @param idStanza
     * @param idUtente
     * @param nome
     * @return
     */
    @Override
    public ResponseEntity&lt;Response&lt;Boolean&gt;&gt; modificaNomePartecipante(String metaID, Long idStanza, Long idUtente, String nome){
<span class="nc" id="L708">        Utente og = utenteRepository.findFirstByMetaId(metaID);</span>
<span class="nc" id="L709">        Stanza stanza = stanzaRepository.findStanzaById(idStanza);</span>

<span class="nc" id="L711">        Utente modifica = utenteRepository.findUtenteById(idUtente);</span>
<span class="nc bnc" id="L712" title="All 2 branches missed.">        if (stanza != null) {</span>
<span class="nc" id="L713">            StatoPartecipazione statoOg = statoPartecipazioneRepository.findStatoPartecipazioneByUtenteAndStanza(og, stanza);</span>
<span class="nc bnc" id="L714" title="All 2 branches missed.">            if (statoOg != null) {</span>
<span class="nc bnc" id="L715" title="All 6 branches missed.">                if (statoOg.getRuolo().getNome().equalsIgnoreCase(Ruolo.ORGANIZZATORE_MASTER) || statoOg.getRuolo().getNome().equalsIgnoreCase(Ruolo.ORGANIZZATORE) &amp;&amp; !statoOg.isBannato()) {</span>

<span class="nc" id="L717">                    StatoPartecipazione statoModifica = statoPartecipazioneRepository.findStatoPartecipazioneByUtenteAndStanza(modifica, stanza);</span>
<span class="nc bnc" id="L718" title="All 2 branches missed.">                    if (statoModifica != null) {</span>
<span class="nc" id="L719">                        statoModifica.setNomeInStanza(nome);</span>
<span class="nc" id="L720">                        statoPartecipazioneRepository.save(statoModifica);</span>

<span class="nc" id="L722">                        return ResponseEntity.ok(new Response&lt;&gt;(true, &quot;Il nome in stanza è stato modificato&quot;));</span>
                    } else {
<span class="nc" id="L724">                        return ResponseEntity.status(403).body(new Response&lt;&gt;(false, &quot;Il partecipante selezionato non è presente nella stanza&quot;));</span>
                    }
                } else {
<span class="nc" id="L727">                    return ResponseEntity.status(403).body(new Response&lt;&gt;(false, &quot;Non puoi modificare il nome in stanza di un utente se non sei almeno un'organizzatore&quot;));</span>
                }
            } else {
<span class="nc" id="L730">                return ResponseEntity.status(403).body(new Response&lt;&gt;(false, &quot;Non puoi modificare il nome in stanza dell'utente selezionato perché non è presente in stanza&quot;));</span>
            }
        }else{
<span class="nc" id="L733">            return ResponseEntity.status(403).body(new Response&lt;&gt;(false, &quot;La stanza selezionata non esiste&quot;));</span>
        }
    }

    /**
     *
     * @param metaID
     * @param idStanza
     * @param idUtente
     * @return
     */
    @Override
    public ResponseEntity&lt;Response&lt;Boolean&gt;&gt; kickPartecipante(String metaID, Long idStanza, Long idUtente){
<span class="nc" id="L746">        Utente og = utenteRepository.findFirstByMetaId(metaID);</span>
<span class="nc" id="L747">        Stanza stanza = stanzaRepository.findStanzaById(idStanza);</span>

<span class="nc" id="L749">        Utente kick = utenteRepository.findUtenteById(idUtente);</span>
<span class="nc bnc" id="L750" title="All 2 branches missed.">            if (stanza != null) {</span>
<span class="nc" id="L751">            StatoPartecipazione statoOg = statoPartecipazioneRepository.findStatoPartecipazioneByUtenteAndStanza(og, stanza);</span>
<span class="nc bnc" id="L752" title="All 2 branches missed.">            if (statoOg != null) {</span>
<span class="nc bnc" id="L753" title="All 6 branches missed.">                if (statoOg.getRuolo().getNome().equalsIgnoreCase(Ruolo.ORGANIZZATORE_MASTER) || statoOg.getRuolo().getNome().equalsIgnoreCase(Ruolo.ORGANIZZATORE) &amp;&amp; !statoOg.isBannato()) {</span>

<span class="nc" id="L755">                    StatoPartecipazione statoKick = statoPartecipazioneRepository.findStatoPartecipazioneByUtenteAndStanza(kick, stanza);</span>
<span class="nc bnc" id="L756" title="All 2 branches missed.">                    if (statoKick != null) {</span>
<span class="nc" id="L757">                        statoPartecipazioneRepository.delete(statoKick);</span>
<span class="nc" id="L758">                        return ResponseEntity.ok(new Response&lt;&gt;(true, &quot;L'utente è stato kickato con successo&quot;));</span>
                    } else {
<span class="nc" id="L760">                        return ResponseEntity.status(403).body(new Response&lt;&gt;(false, &quot;Il partecipante selezionato non è presente nella stanza&quot;));</span>
                    }
                } else {
<span class="nc" id="L763">                    return ResponseEntity.status(403).body(new Response&lt;&gt;(false, &quot;Non puoi kickare un utente se non sei almeno un'organizzatore&quot;));</span>
                }
            } else {
<span class="nc" id="L766">                return ResponseEntity.status(403).body(new Response&lt;&gt;(false, &quot;Il partecipante selezionato non è presente nella stanza&quot;));</span>
            }
        }else{
<span class="nc" id="L769">            return ResponseEntity.status(403).body(new Response&lt;&gt;(false, &quot;La stanza selezionata non esiste&quot;));</span>
        }
    }

    /**
    *
     * @param metaID
     * @param idStanza
     * @return
    */
    @Override
    public Ruolo getRuoloByUserAndStanzaID(String metaID, Long idStanza) throws ServerRuntimeException, RuntimeException403 {

        Utente u;
        Stanza stanza;
<span class="nc bnc" id="L784" title="All 2 branches missed.">        if((u= utenteRepository.findFirstByMetaId(metaID))==null)</span>
<span class="nc" id="L785">            throw new ServerRuntimeException((&quot;Utente non torvato&quot;));</span>
<span class="nc bnc" id="L786" title="All 2 branches missed.">        if((stanza = stanzaRepository.findStanzaById(idStanza))==null)</span>
<span class="nc" id="L787">            throw new RuntimeException403(&quot;Stanza non trovata&quot;);</span>

        StatoPartecipazione sp;
<span class="nc" id="L790">        if((sp=statoPartecipazioneRepository</span>
<span class="nc bnc" id="L791" title="All 2 branches missed.">                .findStatoPartecipazioneByUtenteAndStanza(u,stanza))==null)</span>
<span class="nc" id="L792">            throw new RuntimeException403(&quot;L'utente non ha acceduto alla stanza&quot;);</span>

<span class="nc bnc" id="L794" title="All 2 branches missed.">        if(sp.getRuolo().getNome().equalsIgnoreCase(Ruolo.PARTECIPANTE)){</span>
<span class="nc bnc" id="L795" title="All 2 branches missed.">           if(sp.isBannato())   throw new RuntimeException403(&quot;Utente bannato dalla stanza&quot;);</span>
<span class="nc bnc" id="L796" title="All 2 branches missed.">           if(sp.isInAttesa())   throw new RuntimeException403(&quot;Utente in attesa di entrare in stanza&quot;);</span>
        }

<span class="nc" id="L799">        return sp.getRuolo();</span>
    }

     /**
     * @param Id
     * @return
     */
    @Override
    public Stanza visualizzaStanza(Long Id) {
<span class="nc" id="L808">        return stanzaRepository.findStanzaById(Id);</span>
    }



    /**
     *
     * @return
     */
    public List&lt;Scenario&gt; getAllScenari() {
<span class="nc" id="L818">        return scenarioRepository.findAll();</span>
    }

    public ResponseEntity&lt;Response&lt;Boolean&gt;&gt; UnmutePartecipante(String metaID, Long IdStanza, Long IdUtente){

<span class="nc" id="L823">        Utente og = utenteRepository.findFirstByMetaId(metaID);</span>
<span class="nc" id="L824">        Utente silenzia = utenteRepository.findUtenteById(IdUtente);</span>
<span class="nc" id="L825">        Stanza stanza = stanzaRepository.findStanzaById(IdStanza);</span>

<span class="nc bnc" id="L827" title="All 2 branches missed.">        if(stanza != null) {</span>
<span class="nc" id="L828">            StatoPartecipazione statoOg = statoPartecipazioneRepository.findStatoPartecipazioneByUtenteAndStanza(og, stanza);</span>
<span class="nc bnc" id="L829" title="All 6 branches missed.">            if (statoOg.getRuolo().getNome().equalsIgnoreCase(Ruolo.ORGANIZZATORE_MASTER) || statoOg.getRuolo().getNome().equalsIgnoreCase(Ruolo.ORGANIZZATORE) &amp;&amp; !statoOg.isBannato()) {</span>
<span class="nc" id="L830">                StatoPartecipazione statoSilenzio = statoPartecipazioneRepository.findStatoPartecipazioneByUtenteAndStanza(silenzia, stanza);</span>
<span class="nc bnc" id="L831" title="All 2 branches missed.">                if (statoSilenzio != null) {</span>
<span class="nc bnc" id="L832" title="All 2 branches missed.">                    if (statoSilenzio.isSilenziato()) {</span>
<span class="nc" id="L833">                        statoSilenzio.setSilenziato(false);</span>
<span class="nc" id="L834">                        statoPartecipazioneRepository.save(statoSilenzio);</span>
<span class="nc" id="L835">                        return ResponseEntity.ok(new Response&lt;&gt;(true, &quot;L'utente selezionato ora non è più silenziato&quot;));</span>
                    } else {
<span class="nc" id="L837">                        return ResponseEntity.ok(new Response&lt;&gt;(true, &quot;L'utente selezionato è gia mutato&quot;));</span>
                    }
                } else {
<span class="nc" id="L840">                    return ResponseEntity.status(403).body(new Response&lt;&gt;(false, &quot;L'utente selezioanto non è presente nella stanza&quot;));</span>
                }
            }else{
<span class="nc" id="L843">                return ResponseEntity.status(403).body(new Response&lt;&gt;(false, &quot;Per silenziare un partecipante nella stanza devi essere almeno un organizzatore&quot;));</span>
            }
        }else{
<span class="nc" id="L846">            return ResponseEntity.status(403).body(new Response&lt;&gt;(false, &quot;La stanza selezionata non esiste&quot;));</span>
        }
    }
    /*
    public ResponseEntity&lt;Response&lt;Boolean&gt;&gt; Unmute(String metaID, Long IdStanza) {

        Utente utente = utenteRepository.findFirstByMetaId(metaID);
        Stanza stanza = stanzaRepository.findStanzaById(IdStanza);

        if(stanza != null) {
            StatoPartecipazione statoUtente = statoPartecipazioneRepository.findStatoPartecipazioneByUtenteAndStanza(utente, stanza);
            if (statoUtente != null){
                if (statoUtente.isSilenziato()) {
                        statoUtente.setSilenziato(false);
                        statoPartecipazioneRepository.save(statoUtente);
                        return ResponseEntity.ok(new Response&lt;&gt;(true, &quot;Ora non sei più mutato&quot;));
                } else {
                    return ResponseEntity.ok(new Response&lt;&gt;(true, &quot;Eri era già non mutato&quot;));
                }
            } else {
                return ResponseEntity.status(403).body(new Response&lt;&gt;(false, &quot;L'utente selezioanto non è presente nella stanza&quot;));
            }
        }else{
            return ResponseEntity.status(403).body(new Response&lt;&gt;(false, &quot;La stanza selezionata non esiste&quot;));
        }
    }

    public ResponseEntity&lt;Response&lt;Boolean&gt;&gt; mute(String metaID, Long IdStanza) {

        Utente utente = utenteRepository.findFirstByMetaId(metaID);
        Stanza stanza = stanzaRepository.findStanzaById(IdStanza);

        if(stanza != null) {
            StatoPartecipazione statoUtente = statoPartecipazioneRepository.findStatoPartecipazioneByUtenteAndStanza(utente, stanza);
            if (statoUtente != null){
                if (!statoUtente.isSilenziato()) {
                    statoUtente.setSilenziato(true);
                    statoPartecipazioneRepository.save(statoUtente);
                    return ResponseEntity.ok(new Response&lt;&gt;(true, &quot;Ora sei mutato&quot;));
                } else {
                    return ResponseEntity.ok(new Response&lt;&gt;(true, &quot;Sei già mutato&quot;));
                }
            } else {
                return ResponseEntity.status(403).body(new Response&lt;&gt;(false, &quot;L'utente selezioanto non è presente nella stanza&quot;));
            }
        }else{
            return ResponseEntity.status(403).body(new Response&lt;&gt;(false, &quot;La stanza selezionata non esiste&quot;));
        }
    }
    */
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.9.202303310957</span></div></body></html>